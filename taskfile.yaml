version: '3'

tasks:
  help:
    cmds:
      - glow README.md
    silent: true

  cleanup:
    cmds:
      - find packer/ansible/output/cloud-init/ -type f -name '*.cfg' ! -name '99-pve.cfg' -exec rm -rfv {} +
      - find packer/ansible/output/cloud-init/ -type f -name '*-data' -exec rm -rfv {} +
      - find packer/ansible/output/scripts/ -type f -name '*.sh' -exec truncate -s 0 {} +
      - find packer/ansible/output/ssh_keys/ -type f -name 'ssh_key_*' -exec rm -rfv {} +

  init:
    cmds:
      - packer init packer/

  format:
    cmds:
      - packer fmt -recursive .

  validate:
    requires:
      vars: [OS_DIST, OS_VERSION, PROXMOX_API_TOKEN_ID, PROXMOX_API_TOKEN_SECRET]
    cmds:
      - |
        packer validate \
        -var 'proxmox_api_token_id={{.PROXMOX_API_TOKEN_ID}}' \
        -var 'proxmox_api_token_secret={{.PROXMOX_API_TOKEN_SECRET}}' \
        -var 'os_dist={{.OS_DIST}}' \
        -var 'os_version={{.OS_VERSION}}' \
        packer/

  pre-provisioning:
    requires:
      vars: [OS_DIST, OS_VERSION, PROXMOX_API_TOKEN_ID, PROXMOX_API_TOKEN_SECRET]
    cmds:
      - |
        packer build \
        -var 'proxmox_api_token_id={{.PROXMOX_API_TOKEN_ID}}' \
        -var 'proxmox_api_token_secret={{.PROXMOX_API_TOKEN_SECRET}}' \
        -var 'os_dist={{.OS_DIST}}' \
        -var 'os_version={{.OS_VERSION}}' \
        -only 'pre-provisioning'
        packer/

  template:
    requires:
      vars: [OS_DIST, OS_VERSION, PROXMOX_API_TOKEN_ID, PROXMOX_API_TOKEN_SECRET]
    cmds:
      - |
        packer build \
        -var 'proxmox_api_token_id={{.PROXMOX_API_TOKEN_ID}}' \
        -var 'proxmox_api_token_secret={{.PROXMOX_API_TOKEN_SECRET}}' \
        -var 'os_dist={{.OS_DIST}}' \
        -var 'os_version={{.OS_VERSION}}' \
        packer/
      - defer: { task: cleanup }
